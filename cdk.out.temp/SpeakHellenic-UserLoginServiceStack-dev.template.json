{
  "Description": "User Login Service Stack for dev environment - Authentication and user management",
  "Resources": {
    "UsersTable9725E9C8": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "AttributeDefinitions": [
          {
            "AttributeName": "userId",
            "AttributeType": "S"
          }
        ],
        "BillingMode": "PAY_PER_REQUEST",
        "KeySchema": [
          {
            "AttributeName": "userId",
            "KeyType": "HASH"
          }
        ],
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "SSESpecification": {
          "SSEEnabled": true
        },
        "TableName": "speak-greek-now-users-dev",
        "Tags": [
          {
            "Key": "Component",
            "Value": "UserAuthentication"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          },
          {
            "Key": "Project",
            "Value": "SpeakHellenic"
          }
        ]
      },
      "UpdateReplacePolicy": "Retain",
      "DeletionPolicy": "Retain",
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UsersTable/Resource"
      }
    },
    "UserApiAccessLogs44175256": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": "/aws/apigateway/speak-greek-now-user-api-dev",
        "RetentionInDays": 7
      },
      "UpdateReplacePolicy": "Delete",
      "DeletionPolicy": "Delete",
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApiAccessLogs/Resource"
      }
    },
    "UserApiB6C12381": {
      "Type": "AWS::ApiGateway::RestApi",
      "Properties": {
        "Description": "User management API for Speak Greek Now authentication",
        "Name": "Speak Greek Now User API",
        "Tags": [
          {
            "Key": "Component",
            "Value": "UserAuthentication"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          },
          {
            "Key": "Project",
            "Value": "SpeakHellenic"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Resource"
      }
    },
    "UserApiDeployment248398112744a713f13cb43c51e4523f5f5c23bc": {
      "Type": "AWS::ApiGateway::Deployment",
      "Properties": {
        "Description": "User management API for Speak Greek Now authentication",
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "DependsOn": [
        "UserApiOPTIONSC7FF09BC",
        "UserApiusersuserIdGETBDCA4EA2",
        "UserApiusersuserIdOPTIONS6F37D8D3",
        "UserApiusersuserIdPUT2C65074B",
        "UserApiusersuserId490BEDC2",
        "UserApiusersOPTIONS4D176E40",
        "UserApiusersPOST45B0BA2E",
        "UserApiusers12F31A22"
      ],
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Deployment/Resource"
      }
    },
    "UserApiDeploymentStageprod08A07725": {
      "Type": "AWS::ApiGateway::Stage",
      "Properties": {
        "AccessLogSetting": {
          "DestinationArn": {
            "Fn::GetAtt": ["UserApiAccessLogs44175256", "Arn"]
          },
          "Format": "{\"requestId\":\"$context.requestId\",\"ip\":\"$context.identity.sourceIp\",\"requestTime\":\"$context.requestTime\",\"httpMethod\":\"$context.httpMethod\",\"resourcePath\":\"$context.resourcePath\",\"status\":\"$context.status\",\"protocol\":\"$context.protocol\",\"responseLength\":\"$context.responseLength\"}"
        },
        "DeploymentId": {
          "Ref": "UserApiDeployment248398112744a713f13cb43c51e4523f5f5c23bc"
        },
        "MethodSettings": [
          {
            "DataTraceEnabled": false,
            "HttpMethod": "*",
            "LoggingLevel": "INFO",
            "MetricsEnabled": true,
            "ResourcePath": "/*"
          }
        ],
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        },
        "StageName": "prod",
        "Tags": [
          {
            "Key": "Component",
            "Value": "UserAuthentication"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          },
          {
            "Key": "Project",
            "Value": "SpeakHellenic"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/DeploymentStage.prod/Resource"
      }
    },
    "UserApiOPTIONSC7FF09BC": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "ApiKeyRequired": false,
        "AuthorizationType": "NONE",
        "HttpMethod": "OPTIONS",
        "Integration": {
          "IntegrationResponses": [
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,x-api-key,X-Amz-Security-Token'",
                "method.response.header.Access-Control-Allow-Origin": "'http://localhost:3000'",
                "method.response.header.Vary": "'Origin'",
                "method.response.header.Access-Control-Allow-Methods": "'GET,POST,PUT,OPTIONS'",
                "method.response.header.Access-Control-Allow-Credentials": "'true'"
              },
              "ResponseTemplates": {
                "application/json": "#set($origin = $input.params().header.get(\"Origin\"))\n#if($origin == \"\")\n  #set($origin = $input.params().header.get(\"origin\"))\n#end\n#if($origin == \"https://speakhellenic.com\" || $origin == \"https://www.speakhellenic.com\" || $origin == \"https://development.d3v5vb4u9puz3w.amplifyapp.com\")\n  #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin)\n#end"
              },
              "StatusCode": "204"
            }
          ],
          "RequestTemplates": {
            "application/json": "{ statusCode: 200 }"
          },
          "Type": "MOCK"
        },
        "MethodResponses": [
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Headers": true,
              "method.response.header.Access-Control-Allow-Origin": true,
              "method.response.header.Vary": true,
              "method.response.header.Access-Control-Allow-Methods": true,
              "method.response.header.Access-Control-Allow-Credentials": true
            },
            "StatusCode": "204"
          }
        ],
        "ResourceId": {
          "Fn::GetAtt": ["UserApiB6C12381", "RootResourceId"]
        },
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Default/OPTIONS/Resource"
      }
    },
    "UserApiusers12F31A22": {
      "Type": "AWS::ApiGateway::Resource",
      "Properties": {
        "ParentId": {
          "Fn::GetAtt": ["UserApiB6C12381", "RootResourceId"]
        },
        "PathPart": "users",
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Default/users/Resource"
      }
    },
    "UserApiusersOPTIONS4D176E40": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "ApiKeyRequired": false,
        "AuthorizationType": "NONE",
        "HttpMethod": "OPTIONS",
        "Integration": {
          "IntegrationResponses": [
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,x-api-key,X-Amz-Security-Token'",
                "method.response.header.Access-Control-Allow-Origin": "'http://localhost:3000'",
                "method.response.header.Vary": "'Origin'",
                "method.response.header.Access-Control-Allow-Methods": "'GET,POST,PUT,OPTIONS'",
                "method.response.header.Access-Control-Allow-Credentials": "'true'"
              },
              "ResponseTemplates": {
                "application/json": "#set($origin = $input.params().header.get(\"Origin\"))\n#if($origin == \"\")\n  #set($origin = $input.params().header.get(\"origin\"))\n#end\n#if($origin == \"https://speakhellenic.com\" || $origin == \"https://www.speakhellenic.com\" || $origin == \"https://development.d3v5vb4u9puz3w.amplifyapp.com\")\n  #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin)\n#end"
              },
              "StatusCode": "204"
            }
          ],
          "RequestTemplates": {
            "application/json": "{ statusCode: 200 }"
          },
          "Type": "MOCK"
        },
        "MethodResponses": [
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Headers": true,
              "method.response.header.Access-Control-Allow-Origin": true,
              "method.response.header.Vary": true,
              "method.response.header.Access-Control-Allow-Methods": true,
              "method.response.header.Access-Control-Allow-Credentials": true
            },
            "StatusCode": "204"
          }
        ],
        "ResourceId": {
          "Ref": "UserApiusers12F31A22"
        },
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Default/users/OPTIONS/Resource"
      }
    },
    "UserApiusersuserId490BEDC2": {
      "Type": "AWS::ApiGateway::Resource",
      "Properties": {
        "ParentId": {
          "Ref": "UserApiusers12F31A22"
        },
        "PathPart": "{userId}",
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Default/users/{userId}/Resource"
      }
    },
    "UserApiusersuserIdOPTIONS6F37D8D3": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "ApiKeyRequired": false,
        "AuthorizationType": "NONE",
        "HttpMethod": "OPTIONS",
        "Integration": {
          "IntegrationResponses": [
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,x-api-key,X-Amz-Security-Token'",
                "method.response.header.Access-Control-Allow-Origin": "'http://localhost:3000'",
                "method.response.header.Vary": "'Origin'",
                "method.response.header.Access-Control-Allow-Methods": "'GET,POST,PUT,OPTIONS'",
                "method.response.header.Access-Control-Allow-Credentials": "'true'"
              },
              "ResponseTemplates": {
                "application/json": "#set($origin = $input.params().header.get(\"Origin\"))\n#if($origin == \"\")\n  #set($origin = $input.params().header.get(\"origin\"))\n#end\n#if($origin == \"https://speakhellenic.com\" || $origin == \"https://www.speakhellenic.com\" || $origin == \"https://development.d3v5vb4u9puz3w.amplifyapp.com\")\n  #set($context.responseOverride.header.Access-Control-Allow-Origin = $origin)\n#end"
              },
              "StatusCode": "204"
            }
          ],
          "RequestTemplates": {
            "application/json": "{ statusCode: 200 }"
          },
          "Type": "MOCK"
        },
        "MethodResponses": [
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Headers": true,
              "method.response.header.Access-Control-Allow-Origin": true,
              "method.response.header.Vary": true,
              "method.response.header.Access-Control-Allow-Methods": true,
              "method.response.header.Access-Control-Allow-Credentials": true
            },
            "StatusCode": "204"
          }
        ],
        "ResourceId": {
          "Ref": "UserApiusersuserId490BEDC2"
        },
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Default/users/{userId}/OPTIONS/Resource"
      }
    },
    "UserApiusersuserIdGETBDCA4EA2": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "ApiKeyRequired": true,
        "AuthorizationType": "NONE",
        "HttpMethod": "GET",
        "Integration": {
          "Credentials": {
            "Fn::GetAtt": ["ApiGatewayDynamoDBRole84FBC2AA", "Arn"]
          },
          "IntegrationHttpMethod": "POST",
          "IntegrationResponses": [
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "#set($item = $input.path('$.Item'))\n#if($item && $item.userId)\n{\n  \"userId\": \"$item.userId.S\",\n  \"email\": \"$item.email.S\",\n  \"name\": \"$item.name.S\",\n  \"picture\": \"$item.picture.S\",\n  \"createdAt\": \"$item.createdAt.S\",\n  \"lastLoginAt\": \"$item.lastLoginAt.S\"#if($item.completedLessons),\n  \"completedLessons\": [\n    #foreach($lesson in $item.completedLessons.L)\n    {\n      \"id\": \"$lesson.M.id.S\",\n      \"at\": \"$lesson.M.at.S\"\n    }#if($foreach.hasNext),#end\n    #end\n  ]#end\n}\n#else\n#set($context.responseOverride.status = 404)\n{\"message\": \"User not found\"}\n#end"
              },
              "StatusCode": "200"
            }
          ],
          "RequestTemplates": {
            "application/json": {
              "Fn::Join": [
                "",
                [
                  "{\n  \"TableName\": \"",
                  {
                    "Ref": "UsersTable9725E9C8"
                  },
                  "\",\n  \"Key\": {\n    \"userId\": { \"S\": \"$util.urlDecode($input.params('userId'))\" }\n  }\n}"
                ]
              ]
            }
          },
          "Type": "AWS",
          "Uri": "arn:aws:apigateway:eu-west-1:dynamodb:action/GetItem"
        },
        "MethodResponses": [
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "200"
          },
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "404"
          }
        ],
        "ResourceId": {
          "Ref": "UserApiusersuserId490BEDC2"
        },
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Default/users/{userId}/GET/Resource"
      }
    },
    "UserApiusersuserIdPUT2C65074B": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "ApiKeyRequired": true,
        "AuthorizationType": "NONE",
        "HttpMethod": "PUT",
        "Integration": {
          "Credentials": {
            "Fn::GetAtt": ["ApiGatewayDynamoDBRole84FBC2AA", "Arn"]
          },
          "IntegrationHttpMethod": "POST",
          "IntegrationResponses": [
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "#set($attrs = $input.path('$.Attributes'))\n{\n  \"userId\": \"$attrs.userId.S\",\n  \"email\": \"$attrs.email.S\",\n  \"name\": \"$attrs.name.S\",\n  \"picture\": \"$attrs.picture.S\",\n  \"createdAt\": \"$attrs.createdAt.S\",\n  \"lastLoginAt\": \"$attrs.lastLoginAt.S\"#if($attrs.completedLessons),\n  \"completedLessons\": [\n    #foreach($lesson in $attrs.completedLessons.L)\n    {\n      \"id\": \"$lesson.M.id.S\",\n      \"at\": \"$lesson.M.at.S\"\n    }#if($foreach.hasNext),#end\n    #end\n  ]#end\n}"
              },
              "StatusCode": "200"
            },
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "{ \"error\": \"ValidationError\", \"message\": \"Invalid request: check completedLessons structure or ensure at least one field is provided\" }"
              },
              "SelectionPattern": ".*ValidationError.*",
              "StatusCode": "400"
            },
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "{ \"error\": \"ConditionFailed\", \"message\": \"The update condition was not met\" }"
              },
              "SelectionPattern": ".*ConditionalCheckFailedException.*",
              "StatusCode": "404"
            },
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "{ \"error\": \"ServiceError\", \"message\": \"An internal service error occurred\" }"
              },
              "SelectionPattern": ".*ServiceUnavailable.*|.*InternalServerError.*",
              "StatusCode": "500"
            }
          ],
          "RequestTemplates": {
            "application/json": {
              "Fn::Join": [
                "",
                [
                  "#set($inputRoot = $input.path('$'))\n#set($lastLogin = $inputRoot.lastLoginAt)\n#set($completedLessons = $inputRoot.completedLessons)\n\n## Build update expression and attribute values dynamically\n#set($updates = [])\n#set($attrValues = \"{\")\n#set($hasValues = false)\n\n## lastLoginAt\n#if($lastLogin && $lastLogin != \"\")\n  #set($void = $updates.add(\"lastLoginAt = :lastLoginAt\"))\n  #if($hasValues)#set($attrValues = \"$attrValues,\")#end\n  #set($attrValues = \"$attrValues\"\":lastLoginAt\"\": {\"\"S\"\": \"\"$lastLogin\"\"}\")\n  #set($hasValues = true)\n#end\n\n## completedLessons (supports empty array)\n#if($completedLessons)\n  #set($void = $updates.add(\"completedLessons = :completedLessons\"))\n  #if($hasValues)#set($attrValues = \"$attrValues,\")#end\n  #set($attrValues = \"$attrValues\"\":completedLessons\"\": {\"\"L\"\": [\")\n  #set($first = true)\n  #foreach($lesson in $completedLessons)\n    #if(!$first)#set($attrValues = \"$attrValues,\")#end\n    #set($attrValues = \"$attrValues{\"\"M\"\": {\"\"id\"\": {\"\"S\"\": \"\"$lesson.id\"\"}, \"\"at\"\": {\"\"S\"\": \"\"$lesson.at\"\"}}}\")\n    #set($first = false)\n  #end\n  #set($attrValues = \"$attrValues]}\")\n  #set($hasValues = true)\n#end\n\n#set($attrValues = \"$attrValues}\")\n\n## Build final update expression\n#set($updateExpr = \"SET \")\n#foreach($update in $updates)\n$update#if($foreach.hasNext), #end\n#end\n\n{\n  \"TableName\": \"",
                  {
                    "Ref": "UsersTable9725E9C8"
                  },
                  "\",\n  \"Key\": {\n    \"userId\": { \"S\": \"$util.urlDecode($input.params('userId'))\" }\n  },\n  \"UpdateExpression\": \"$updateExpr\",\n  \"ConditionExpression\": \"attribute_exists(userId)\",\n  \"ExpressionAttributeValues\": $attrValues,\n  \"ReturnValues\": \"ALL_NEW\"\n}"
                ]
              ]
            }
          },
          "Type": "AWS",
          "Uri": "arn:aws:apigateway:eu-west-1:dynamodb:action/UpdateItem"
        },
        "MethodResponses": [
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "200"
          },
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "400"
          },
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "404"
          },
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "500"
          }
        ],
        "ResourceId": {
          "Ref": "UserApiusersuserId490BEDC2"
        },
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Default/users/{userId}/PUT/Resource"
      }
    },
    "UserApiusersPOST45B0BA2E": {
      "Type": "AWS::ApiGateway::Method",
      "Properties": {
        "ApiKeyRequired": true,
        "AuthorizationType": "NONE",
        "HttpMethod": "POST",
        "Integration": {
          "Credentials": {
            "Fn::GetAtt": ["ApiGatewayDynamoDBRole84FBC2AA", "Arn"]
          },
          "IntegrationHttpMethod": "POST",
          "IntegrationResponses": [
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "#set($attrs = $input.path('$.Attributes'))\n{\n  \"userId\": \"$attrs.userId.S\",\n  \"email\": \"$attrs.email.S\",\n  \"name\": \"$attrs.name.S\",\n  \"picture\": \"$attrs.picture.S\",\n  \"createdAt\": \"$attrs.createdAt.S\",\n  \"lastLoginAt\": \"$attrs.lastLoginAt.S\"\n}"
              },
              "StatusCode": "200"
            },
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "{ \"error\": \"ValidationError\", \"message\": \"Missing required fields: userId and email are required\" }"
              },
              "SelectionPattern": ".*/error.*",
              "StatusCode": "400"
            },
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "{ \"error\": \"UserAlreadyExists\", \"message\": \"A user with this userId already exists\" }"
              },
              "SelectionPattern": ".*ConditionalCheckFailedException.*",
              "StatusCode": "400"
            },
            {
              "ResponseParameters": {
                "method.response.header.Access-Control-Allow-Origin": "'*'"
              },
              "ResponseTemplates": {
                "application/json": "{ \"error\": \"ServiceError\", \"message\": \"An internal service error occurred\" }"
              },
              "SelectionPattern": ".*ServiceUnavailable.*|.*InternalServerError.*",
              "StatusCode": "500"
            }
          ],
          "RequestTemplates": {
            "application/json": {
              "Fn::Join": [
                "",
                [
                  "#set($userId = $input.path('$.userId'))\n#set($email = $input.path('$.email'))\n#set($name = $input.path('$.name'))\n#set($picture = $input.path('$.picture'))\n#set($createdAt = $input.path('$.createdAt'))\n#set($lastLoginAt = $input.path('$.lastLoginAt'))\n{\n  \"TableName\": \"",
                  {
                    "Ref": "UsersTable9725E9C8"
                  },
                  "\",\n  \"Item\": {\n    \"userId\": { \"S\": \"$userId\" },\n    \"email\": { \"S\": \"$email\" },\n    \"name\": { \"S\": \"$name\" },\n    \"picture\": { \"S\": \"$picture\" },\n    \"createdAt\": { \"S\": \"$createdAt\" },\n    \"lastLoginAt\": { \"S\": \"$lastLoginAt\" }\n  },\n  \"ConditionExpression\": \"attribute_not_exists(userId)\",\n  \"ReturnValues\": \"ALL_NEW\"\n}"
                ]
              ]
            }
          },
          "Type": "AWS",
          "Uri": "arn:aws:apigateway:eu-west-1:dynamodb:action/PutItem"
        },
        "MethodResponses": [
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "200"
          },
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "400"
          },
          {
            "ResponseParameters": {
              "method.response.header.Access-Control-Allow-Origin": true
            },
            "StatusCode": "500"
          }
        ],
        "ResourceId": {
          "Ref": "UserApiusers12F31A22"
        },
        "RestApiId": {
          "Ref": "UserApiB6C12381"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/Default/users/POST/Resource"
      }
    },
    "UserApiUserApiKey302629E5": {
      "Type": "AWS::ApiGateway::ApiKey",
      "Properties": {
        "Description": "API key for frontend authentication",
        "Enabled": true,
        "Name": "speak-greek-now-user-api-key",
        "StageKeys": [
          {
            "RestApiId": {
              "Ref": "UserApiB6C12381"
            },
            "StageName": {
              "Ref": "UserApiDeploymentStageprod08A07725"
            }
          }
        ],
        "Tags": [
          {
            "Key": "Component",
            "Value": "UserAuthentication"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          },
          {
            "Key": "Project",
            "Value": "SpeakHellenic"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/UserApiKey/Resource"
      }
    },
    "UserApiUserApiUsagePlanAB07E32D": {
      "Type": "AWS::ApiGateway::UsagePlan",
      "Properties": {
        "ApiStages": [
          {
            "ApiId": {
              "Ref": "UserApiB6C12381"
            },
            "Stage": {
              "Ref": "UserApiDeploymentStageprod08A07725"
            },
            "Throttle": {}
          }
        ],
        "Description": "Usage plan optimized for MVP scale (200 req/min target)",
        "Quota": {
          "Limit": 5000,
          "Period": "MONTH"
        },
        "Tags": [
          {
            "Key": "Component",
            "Value": "UserAuthentication"
          },
          {
            "Key": "Environment",
            "Value": "dev"
          },
          {
            "Key": "Project",
            "Value": "SpeakHellenic"
          }
        ],
        "Throttle": {
          "BurstLimit": 20,
          "RateLimit": 10
        },
        "UsagePlanName": "MVP Usage Plan"
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/UserApiUsagePlan/Resource"
      }
    },
    "UserApiUserApiUsagePlanUsagePlanKeyResourceSpeakHellenicUserLoginServiceStackdevUserApiUserApiKey791F971567F8DD65": {
      "Type": "AWS::ApiGateway::UsagePlanKey",
      "Properties": {
        "KeyId": {
          "Ref": "UserApiUserApiKey302629E5"
        },
        "KeyType": "API_KEY",
        "UsagePlanId": {
          "Ref": "UserApiUserApiUsagePlanAB07E32D"
        }
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApi/UserApiUsagePlan/UsagePlanKeyResource:SpeakHellenicUserLoginServiceStackdevUserApiUserApiKey791F9715"
      }
    },
    "ApiGatewayDynamoDBRole84FBC2AA": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "apigateway.amazonaws.com"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Description": "Allows API Gateway to perform operations on DynamoDB users table"
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/ApiGatewayDynamoDBRole/Resource"
      }
    },
    "ApiGatewayDynamoDBRoleDefaultPolicy0337A457": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "dynamodb:BatchGetItem",
                "dynamodb:BatchWriteItem",
                "dynamodb:ConditionCheckItem",
                "dynamodb:DeleteItem",
                "dynamodb:DescribeTable",
                "dynamodb:GetItem",
                "dynamodb:GetRecords",
                "dynamodb:GetShardIterator",
                "dynamodb:PutItem",
                "dynamodb:Query",
                "dynamodb:Scan",
                "dynamodb:UpdateItem"
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": ["UsersTable9725E9C8", "Arn"]
                },
                {
                  "Ref": "AWS::NoValue"
                }
              ]
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "ApiGatewayDynamoDBRoleDefaultPolicy0337A457",
        "Roles": [
          {
            "Ref": "ApiGatewayDynamoDBRole84FBC2AA"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/ApiGatewayDynamoDBRole/DefaultPolicy/Resource"
      }
    },
    "UserApiErrorAlarm15DE052C": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmDescription": "Alert when User API has high error rate (4xx/5xx)",
        "AlarmName": "SpeakHellenic-UserApi-HighErrorRate",
        "ComparisonOperator": "GreaterThanOrEqualToThreshold",
        "EvaluationPeriods": 2,
        "Metrics": [
          {
            "Expression": "clientErrors + serverErrors",
            "Id": "expr_1"
          },
          {
            "Id": "clientErrors",
            "MetricStat": {
              "Metric": {
                "Dimensions": [
                  {
                    "Name": "ApiName",
                    "Value": "Speak Greek Now User API"
                  }
                ],
                "MetricName": "4XXError",
                "Namespace": "AWS/ApiGateway"
              },
              "Period": 300,
              "Stat": "Sum"
            },
            "ReturnData": false
          },
          {
            "Id": "serverErrors",
            "MetricStat": {
              "Metric": {
                "Dimensions": [
                  {
                    "Name": "ApiName",
                    "Value": "Speak Greek Now User API"
                  }
                ],
                "MetricName": "5XXError",
                "Namespace": "AWS/ApiGateway"
              },
              "Period": 300,
              "Stat": "Sum"
            },
            "ReturnData": false
          }
        ],
        "Threshold": 10,
        "TreatMissingData": "notBreaching"
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/UserApiErrorAlarm/Resource"
      }
    },
    "CDKMetadata": {
      "Type": "AWS::CDK::Metadata",
      "Properties": {
        "Analytics": "v2:deflate64:H4sIAAAAAAAA/22PT0/DMAzFP8vuqWGVBucCEoeBNnVwRm5iumxpEjUJVRXlu6P0jzQkTv75PcvPLmH7+AD3GxxcwcW1ULKBePLIrwwH9xXFqLEzooH4gY0i9vytJ0hMmdZBfDPta2+CzcbKiaGVLXoacIRYk/OVlXlgxReyyowdaZ/Vm+7ksZ0yZqjJmdBzekJH7J382YhsLrS6y+aZKyv3NGZpoU+HLR0V6qz93+xpTExiB7E284tTPRol+bRqpsS4MkEM6PkZYqWw76acDCn9OecQvA3+9rDEtBEEF3f3U+6ghO3m4qQs+qC97Ajquf4CUdg3PI4BAAA="
      },
      "Metadata": {
        "aws:cdk:path": "SpeakHellenic-UserLoginServiceStack-dev/CDKMetadata/Default"
      }
    }
  },
  "Outputs": {
    "UserApiEndpoint22DD5314": {
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Ref": "UserApiB6C12381"
            },
            ".execute-api.eu-west-1.",
            {
              "Ref": "AWS::URLSuffix"
            },
            "/",
            {
              "Ref": "UserApiDeploymentStageprod08A07725"
            },
            "/"
          ]
        ]
      }
    },
    "UserApiUrl": {
      "Description": "User API Gateway URL (provide to frontend team)",
      "Value": {
        "Fn::Join": [
          "",
          [
            "https://",
            {
              "Ref": "UserApiB6C12381"
            },
            ".execute-api.eu-west-1.",
            {
              "Ref": "AWS::URLSuffix"
            },
            "/",
            {
              "Ref": "UserApiDeploymentStageprod08A07725"
            },
            "/"
          ]
        ]
      },
      "Export": {
        "Name": "UserApiUrl"
      }
    },
    "UserApiKeyId": {
      "Description": "User API Key ID (retrieve value with: aws apigateway get-api-key --api-key <id> --include-value)",
      "Value": {
        "Ref": "UserApiUserApiKey302629E5"
      },
      "Export": {
        "Name": "UserApiKeyId"
      }
    },
    "UsersTableName": {
      "Description": "DynamoDB users table name",
      "Value": {
        "Ref": "UsersTable9725E9C8"
      },
      "Export": {
        "Name": "UsersTableName"
      }
    },
    "UsersTableArn": {
      "Description": "DynamoDB users table ARN",
      "Value": {
        "Fn::GetAtt": ["UsersTable9725E9C8", "Arn"]
      },
      "Export": {
        "Name": "UsersTableArn"
      }
    },
    "AccessLogGroupName": {
      "Description": "CloudWatch Log Group for API access logs",
      "Value": {
        "Ref": "UserApiAccessLogs44175256"
      },
      "Export": {
        "Name": "UserApiAccessLogGroup"
      }
    }
  },
  "Parameters": {
    "BootstrapVersion": {
      "Type": "AWS::SSM::Parameter::Value<String>",
      "Default": "/cdk-bootstrap/sgn2026/version",
      "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
    }
  },
  "Rules": {
    "CheckBootstrapVersion": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Contains": [
                  ["1", "2", "3", "4", "5"],
                  {
                    "Ref": "BootstrapVersion"
                  }
                ]
              }
            ]
          },
          "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
        }
      ]
    }
  }
}
